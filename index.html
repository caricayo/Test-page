<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BTC Explainer — Reliable Update (with fallback)</title>
<style>
  :root{--bg:#0f1115;--panel:#121722;--card:#171a21;--ink:#e9eef7;--muted:#a9b4c2;--accent:#7aa2ff;--good:#a2ffd3;--bad:#ff8a8a}
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1d2233 0%,#0f1115 60%);color:var(--ink);-webkit-font-smoothing:antialiased;line-height:1.6}
  .layout{max-width:1100px;margin:0 auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  h1{margin:.2rem 0 .4rem 0;font-size:1.6rem}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  button{appearance:none;border:1px solid rgba(255,255,255,.18);background:#22283a;color:var(--ink);border-radius:10px;padding:10px 12px;font-size:.95rem}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:10px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.06));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .price{font-size:2rem;font-weight:700}
  .sub{color:var(--muted)}
  .good{color:var(--good)} .bad{color:var(--bad)}
  canvas{width:100%;height:240px;background:#0c1018;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
  .small{font-size:.9rem;color:var(--muted)}
  .archive-item{border-top:1px dashed rgba(255,255,255,.15);padding-top:8px;margin-top:8px}
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .pill{display:inline-block;padding:4px 8px;border:1px solid rgba(255,255,255,.2);border-radius:999px;margin-right:6px;font-size:.85rem}
  .status{margin-top:6px;font-size:.9rem}
</style>
</head>
<body>
<div class="layout">
  <header>
    <div>
      <h1>BTC Explainer — Reliable Update</h1>
      <div class="sub">Tries CoinGecko first; if blocked, falls back to Binance. Saves a snapshot each time.</div>
    </div>
    <div class="controls">
      <button id="update">Update now</button>
      <button id="use-demo">Use demo data</button>
      <button id="clear-archive">Clear archive</button>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="row">
        <div class="price" id="price">—</div>
        <div>
          <div><span class="pill" id="p1m">1m: —</span><span class="pill" id="p15m">15m: —</span><span class="pill" id="p60m">60m: —</span></div>
          <div class="small" id="time">Last update: —</div>
          <div class="status" id="status">Status: idle</div>
        </div>
      </div>
      <canvas id="chart" width="800" height="240" aria-label="BTC last 60 minutes chart"></canvas>
      <div class="small">Tip: If an in-app browser blocks APIs, open this page via your GitHub Pages URL directly in Safari.</div>
    </section>

    <section class="card">
      <h3 style="margin:.2rem 0 .4rem 0">Explanation</h3>
      <div id="summary">Press “Update now” to fetch data.</div>
    </section>
  </div>

  <section class="card" style="margin-top:14px">
    <h3 style="margin:.2rem 0 .4rem 0">Archive (on this device)</h3>
    <div class="small">Each time you press “Update now,” a snapshot is saved with the analysis.</div>
    <div id="archive"></div>
  </section>

  <p class="small">Educational use only — not financial advice.</p>
</div>

<script>
const CG="https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1&interval=minutely";
const BINANCE="https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=120";
const fmtUSD=x=>x==null?"—":"$"+x.toLocaleString(undefined,{maximumFractionDigits:2});

function drawChart(ctx,prices){
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  const w=ctx.canvas.width,h=ctx.canvas.height,ys=prices.map(p=>p[1]);
  const min=Math.min(...ys),max=Math.max(...ys),pad=(max-min)*0.1||1,lo=min-pad,hi=max+pad;
  ctx.strokeStyle="rgba(255,255,255,.08)";ctx.lineWidth=1;
  for(let i=0;i<5;i++){const y=i*(h-20)/4+10;ctx.beginPath();ctx.moveTo(40,y);ctx.lineTo(w-10,y);ctx.stroke();}
  ctx.fillStyle="rgba(233,238,247,.7)";ctx.font="12px -apple-system, system-ui, sans-serif";
  ctx.fillText(fmtUSD(hi),6,12);ctx.fillText(fmtUSD(lo),6,h-6);
  const left=40,right=w-10,top=10,bottom=h-10,n=prices.length;
  ctx.lineWidth=2;ctx.beginPath();
  for(let i=0;i<n;i++){const x=left+(i/(n-1))*(right-left);const yVal=prices[i][1];
    const y=bottom-((yVal-lo)/(hi-lo))*(bottom-top); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);}
  ctx.strokeStyle="#7aa2ff";ctx.stroke();
  const lastX=right,lastYVal=prices[n-1][1];
  const lastY=bottom-((lastYVal-lo)/(hi-lo))*(bottom-top);
  ctx.fillStyle="#a2ffd3";ctx.beginPath();ctx.arc(lastX,lastY,4,0,Math.PI*2);ctx.fill();
}

function linearRegression(y){
  const n=y.length,xs=Array.from({length:n},(_,i)=>i);
  const sum=a=>a.reduce((x,y)=>x+y,0);
  const sumx=sum(xs),sumy=sum(y),sumxy=sum(xs.map((x,i)=>x*y[i])),sumx2=sum(xs.map(x=>x*x));
  const slope=(n*sumxy-sumx*sumy)/(n*sumx2-sumx*sumx); const intercept=(sumy-slope*sumx)/n;
  const ymean=sumy/n; const ssTot=sum(y.map(v=>(v-ymean)*(v-ymean)));
  const ssRes=sum(y.map((v,i)=>{const f=slope*xs[i]+intercept;return (v-f)*(v-f)}));
  const r2=1-(ssRes/ssTot); return {slope,r2};
}

function analyze(prices,volumes){
  const last=prices[prices.length-1][1],idx=prices.length-1;
  const pick=m=>prices[Math.max(0,idx-m)][1]; const ch=(a,b)=>((a-b)/b)*100;
  const p1=pick(1),p15=pick(15),p60=pick(60); const c1=ch(last,p1),c15=ch(last,p15),c60=ch(last,p60);
  const lastN=prices.slice(-30).map(p=>p[1]); const {slope,r2}=linearRegression(lastN);
  const mean=lastN.reduce((a,b)=>a+b,0)/lastN.length;
  const sd=Math.sqrt(lastN.reduce((a,b)=>a+(b-mean)*(b-mean),0)/lastN.length);
  const volNow=volumes.slice(-30).map(v=>v[1]); const volMean=volNow.reduce((a,b)=>a+b,0)/volNow.length;
  const volLast=volumes[volumes.length-1][1];
  const window=prices.slice(-60).map(p=>p[1]); const recentMin=Math.min(...window),recentMax=Math.max(...window);
  const dir=slope>0?"up":"down"; const momentum=Math.abs(slope)/(mean||1);
  let momLabel=momentum>0.002?"strong":momentum>0.001?"moderate":"weak";
  const volNote=volLast>volMean*1.3?"above":volLast<volMean*0.7?"below":"near";
  const pos=last<recentMin+(recentMax-recentMin)*0.15?"near recent support":last>recentMax-(recentMax-recentMin)*0.15?"near recent resistance":"mid-range";
  const expl=[]; expl.push(`Trend (last 30 min): <b>${dir}</b> with <b>${momLabel}</b> momentum (R² ${r2.toFixed(2)}).`);
  expl.push(`Change: 1m <b>${c1.toFixed(2)}%</b>, 15m <b>${c15.toFixed(2)}%</b>, 60m <b>${c60.toFixed(2)}%</b>.`);
  expl.push(`Volatility (30m stdev): <b>${sd.toFixed(2)}</b> USD.`);
  expl.push(`Volume now is <b>${volNote}</b> its 30m average.`);
  expl.push(`Price is <b>${pos}</b> (60m range: ${fmtUSD(recentMin)} – ${fmtUSD(recentMax)}).`);
  return {last,c1,c15,c60,summary:"<ul><li>"+expl.join("</li><li>")+"</li></ul>"};
}

function saveArchive(obj){
  const key="btc_explainer_archive_v2";
  const arr=JSON.parse(localStorage.getItem(key)||"[]"); arr.unshift(obj);
  localStorage.setItem(key,JSON.stringify(arr.slice(0,200))); renderArchive();
}
function renderArchive(){
  const key="btc_explainer_archive_v2";
  const arr=JSON.parse(localStorage.getItem(key)||"[]");
  const box=document.getElementById('archive');
  if(arr.length===0){box.innerHTML='<div class="small">No snapshots yet.</div>';return}
  box.innerHTML=arr.map(a=>{
    const cls=a.c1>=0?'good':'bad';
    return `<div class="archive-item"><div><b>${a.time}</b> — <span class="${cls}">${fmtUSD(a.last)}</span> (1m ${a.c1.toFixed(2)}%, 15m ${a.c15.toFixed(2)}%)</div><div class="small">${a.source} • ${a.summary.replace(/<[^>]+>/g,' ').slice(0,220)}…</div></div>`;
  }).join("");
}

async function fetchCoingecko(){
  const res=await fetch(CG,{cache:'no-store'}); if(!res.ok) throw new Error("CoinGecko HTTP "+res.status);
  const data=await res.json(); return {source:"CoinGecko",prices:data.prices.slice(-120),volumes:data.total_volumes.slice(-120)};
}
async function fetchBinance(){
  const res=await fetch(BINANCE,{cache:'no-store'}); if(!res.ok) throw new Error("Binance HTTP "+res.status);
  const rows=await res.json();
  const prices=rows.map(r=>[r[0],parseFloat(r[4])]); const volumes=rows.map(r=>[r[0],parseFloat(r[5])]);
  return {source:"Binance (USDT≈USD)",prices,volumes};
}

async function updateNow(){
  const priceEl=document.getElementById('price'), timeEl=document.getElementById('time');
  const p1=document.getElementById('p1m'), p15=document.getElementById('p15m'), p60=document.getElementById('p60m');
  const ctx=document.getElementById('chart').getContext('2d'); const summary=document.getElementById('summary');
  const status=document.getElementById('status');
  priceEl.textContent="Loading…"; status.textContent="Status: contacting CoinGecko…";
  let payload,src;
  try{payload=await fetchCoingecko(); src=payload.source}
  catch(err1){status.textContent="Status: CoinGecko failed ("+err1.message+"). Trying Binance…";
    try{payload=await fetchBinance(); src=payload.source}
    catch(err2){status.innerHTML=`Status: <span class="bad">Both sources failed.</span> (${err1.message}; ${err2.message})`; priceEl.textContent="—"; summary.innerHTML=`<span class="bad">Could not fetch live data.</span>`; return}}
  const {prices,volumes}=payload;
  drawChart(ctx,prices.slice(-60));
  const a=analyze(prices,volumes);
  priceEl.innerHTML=fmtUSD(a.last);
  p1.textContent="1m: "+(a.c1>=0?"+":"")+a.c1.toFixed(2)+"%";
  p15.textContent="15m: "+(a.c15>=0?"+":"")+a.c15.toFixed(2)+"%";
  p60.textContent="60m: "+(a.c60>=0?"+":"")+a.c60.toFixed(2)+"%";
  p1.style.color=a.c1>=0?"var(--good)":"var(--bad)";
  p15.style.color=a.c15>=0?"var(--good)":"var(--bad)";
  p60.style.color=a.c60>=0?"var(--good)":"var(--bad)";
  const now=new Date(); timeEl.textContent="Last update: "+now.toLocaleTimeString();
  summary.innerHTML=a.summary; status.textContent="Status: OK • Source: "+src;
  saveArchive({time:now.toLocaleString(),last:a.last,c1:a.c1,c15:a.c15,summary:a.summary,source:src});
}

function demoData(){
  const now=Date.now(), base=60000+Math.random()*500-250; let prices=[],volumes=[],p=base;
  for(let i=119;i>=0;i--){p+=(Math.random()-0.5)*60+(i>60?0.1:-0.1)*50; prices.push([now-i*60000,p]); volumes.push([now-i*60000,50+Math.random()*50])}
  return {prices,volumes,source:"Demo"};
}

document.getElementById('update').addEventListener('click',updateNow);
document.getElementById('use-demo').addEventListener('click',()=>{
  const {prices,volumes,source}=demoData(); const ctx=document.getElementById('chart').getContext('2d');
  drawChart(ctx,prices.slice(-60)); const a=analyze(prices,volumes);
  document.getElementById('price').textContent=fmtUSD(a.last);
  document.getElementById('p1m').textContent="1m: "+(a.c1>=0?"+":"")+a.c1.toFixed(2)+"%";
  document.getElementById('p15m').textContent="15m: "+(a.c15>=0?"+":"")+a.c15.toFixed(2)+"%";
  document.getElementById('p60m').textContent="60m: "+(a.c60>=0?"+":"")+a.c60.toFixed(2)+"%";
  document.getElementById('summary').innerHTML=a.summary; document.getElementById('status').textContent="Status: Demo mode";
  saveArchive({time:new Date().toLocaleString(),last:a.last,c1:a.c1,c15:a.c15,summary:a.summary,source});
});
document.getElementById('clear-archive').addEventListener('click',()=>{localStorage.removeItem("btc_explainer_archive_v2");renderArchive()});
renderArchive();
</script>
</body>
</html>
